# -*- coding: utf-8 -*-
"""Rent_prediction_Curitiba-PR_app.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1OzLmLSkgX_MYjhgysq3eR_Jugbfjn-kt
"""

import numpy as np 
import pandas as pd
import streamlit as st
import geopandas as gpd
import plotly.graph_objs as go
import pickle 

url_map_data = 'https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/map_data.geojson'
map_data = gpd.read_file(url_map_data)

model = pickle.load(open('RF_model','rb'))

### Displaying text
##The title of your App can be displayed with st.title
st.title("Previsão de aluguéis - Curitiba-PR") #you could also use st.write("# YOURTITLE")

### Displaying an image
## st.image allows you to display an image from a url or numpy array, a BytesIO object and more
st.image("https://media-cdn.tripadvisor.com/media/photo-b/2560x500/15/33/fd/77/curitiba.jpg",
         width = 800)

##st.write allows you to write text either with single quotes for one line in markdown format
st.write("Prevendo o valor mediano de um apartamento dentro da cidade de **Curitiba-PR**. Siga os 4 passos indicados no app para prever o valor")

#map_data = map_data.to_crs(epsg=4326) # convert the coordinate reference system to lat/long
lga_json = map_data.__geo_interface__ #covert to geoJSON

MAPBOX_ACCESSTOKEN = 'pk.eyJ1IjoiZm1hcmNlbG5ldmVzIiwiYSI6ImNranN3NDkzNTcxYmIzM255dzEzMzA0bm4ifQ.Exq1iIAFQfPb3_sSTMiDZw'

# Set the data for the map
data = go.Choroplethmapbox(
        geojson = lga_json,             #this is your GeoJSON
        locations = map_data.index,    #the index of this dataframe should align with the 'id' element in your geojson
        z = map_data.IDHM, #sets the color value
        text = map_data.bairro,    #sets text for each shape
        colorbar=dict(thickness=14, ticklen=3,outlinewidth=0, title = "IDHM"), #adjusts the format of the colorbar
        marker_line_width=1, marker_opacity=0.7, colorscale="sunset", #adjust format of the plot
        hovertemplate = "<b>%{text}</b><br>" +
                    "%{z}<br>" +
                    "<extra></extra>")  # sets the format of the text shown when you hover over each shape
# Set the layout for the map
layout = go.Layout(
    #title = {'text': f"Mapa dos valores de IDHM de cada um dos bairros de Curitiba-PR",
    #       'font': {'size':14}},       #format the plot title
    mapbox1 = dict(
        domain = {'x': [0, 1],'y': [0, 1]}, 
        center = dict(lat=-25.5139519 , lon=-49.3883419),
        accesstoken = MAPBOX_ACCESSTOKEN, 
        zoom = 10),                      
    autosize=True,
    height=600,
    margin=dict(l=0, r=0, t=40, b=0))
# Generate the map
fig=go.Figure(data=data, layout=layout)

regional_to_onehot = {'Regional bairro novo': np.array([1, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
                    'Regional boa vista': np.array([0, 1, 0, 0, 0, 0, 0, 0, 0, 0]),
                    'Regional boqueirao': np.array([0, 0, 1, 0, 0, 0, 0, 0, 0, 0]),
                    'Regional cajuru': np.array([0, 0, 0, 1, 0, 0, 0, 0, 0, 0]),
                    'Regional cic': np.array([0, 0, 0, 0, 1, 0, 0, 0, 0, 0]), 
                    'Regional matriz': np.array([0, 0, 0, 0, 0, 1, 0, 0, 0, 0]), 
                    'Regional pinheirinho': np.array([0, 0, 0, 0, 0, 0, 1, 0, 0, 0]), 
                    'Regional portao': np.array([0, 0, 0, 0, 0, 0, 0, 1, 0, 0]), 
                    'Regional santa felicidade': np.array([0, 0, 0, 0, 0, 0, 0, 0, 1, 0]),
                    'Regional tatuquara': np.array([0, 0, 0, 0, 0, 0, 0, 0, 0, 1])}

def preparing(quartos, areas, IDHM, regional):
    quartos_prep = int(quartos)
    areas_prep = int(areas)
    IDHM_prep = float(IDHM)
    regional_prep = regional_to_onehot[regional]                  
    features = np.r_[quartos_prep, areas_prep, IDHM_prep, regional_prep].reshape(1, -1)
    return features

def main():
    st.sidebar.write("Autor: Felipe Marcel Neves, repositório: https://github.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR")
    st.header('Passo 1. Parâmetros iniciais de entrada do usuário')
    quartos = st.select_slider("Número de quartos no apartamento", options=[1, 2, 3, 4, 5], value = 2)
    areas = st.slider("Área (m2) do Apartamento", rental["areas"].min(), 200, int(rental["areas"].median()))  
    st.header('Passo 2. Escolha a regional')
    regional = st.selectbox("",('Regional bairro novo',	'Regional boa vista',	'Regional boqueirao', 'Regional cajuru',
                                    'Regional cic',	'Regional matriz', 'Regional pinheirinho', 'Regional portao',
                                    'Regional santa felicidade', 'Regional tatuquara')) 

    if regional == 'Regional bairro novo':
     col1, col2 = st.beta_columns(2)
     col1.image('https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_bairro-novo.png', use_column_width='auto', caption='Demandas da regional Bairro Novo')
     col2.image('https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_total.png', use_column_width='auto')
     st.write('Você selecionou a regional Bairro Novo. Esta regional é composta dos Bairros: **Ganchinho**, **Sitio Cercado** e **Umbará**.')
    elif regional == 'Regional boa vista':
     col1, col2 = st.beta_columns(2)
     col1.image("https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_boa-vista.png", use_column_width='auto', width=200, caption='Demandas da regional Boa Vista')
     col2.image('https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_total.png', use_column_width='auto')
     st.write("Você selecionou a regional Boa Vista. Esta regional é composta dos Bairros: **Abranches**,	**Atuba**, **Bacacheri**, **Bairro Alto**,	**Barreirinha**,	**Boa Vista**,	**Cachoeira**,	**Pilarzinho**, **Santa Cândida**,	**São Lourenço**,	**Taboão** e	**Tingui**.")
    elif regional == 'Regional boqueirao':
     col1, col2 = st.beta_columns(2)        
     col1.image("https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_boqueir%C3%A2o.png", use_column_width='auto', caption='Demandas da regional Boqueirão')
     col2.image('https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_total.png', use_column_width='auto')
     st.write("Você selecionou a regional Boqueirão. Esta regional é composta dos Bairros: **Alto Boqueirão**,	**Boqueirão**, **Hauer** e **Xaxim**.")       
    elif regional == 'Regional cajuru':
     col1, col2 = st.beta_columns(2)     
     col1.image("https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_cajuru.png", use_column_width='auto', caption='Demandas da regional Cajuru')
     col2.image('https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_total.png', use_column_width='auto')
     st.write("Você selecionou a regional Cajuru. Esta regional é composta dos Bairros: **Cajuru**,	**Capão da Imbuia**, **Guabirotuba**, **Jardim das Américas**, **Uberaba** e **Tarumã**.")          
    elif regional == 'Regional cic':
     col1, col2 = st.beta_columns(2) 
     col1.image("https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_cic.png", use_column_width='auto', caption='Demandas da regional CIC')
     col2.image('https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_total.png', use_column_width='auto')
     st.write("Você selecionou a regional CIC. Esta regional é composta dos Bairros: **Augusta**,	**CIC**, **Riviera**, **São Miguel**.")
    elif regional == 'Regional matriz':
     col1, col2 = st.beta_columns(2) 
     col1.image("https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_matriz.png", use_column_width='auto', caption='Demandas da regional Matriz')
     col2.image('https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_total.png', use_column_width='auto')
     st.write("Você selecionou a regional Matriz. Esta regional é composta dos Bairros: **Ahú**, **Bom Retiro**, **Hugo Lange**	**Prado Velho**,	**Alto da Glória**,	**Cabral**,	**Jardim Botânico**,	**Rebouças**,	**Alto da XV**,	**Centro**,	**Jardim Social**,	**São Francisco**,	**Batel**,	**Centro Cívico**,	**Juvevê**,	**Bigorrilho**,	**Cristo Rei** e	**Mercês**.") 
    elif regional == 'Regional pinheirinho':
     col1, col2 = st.beta_columns(2) 
     col1.image("https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_pinheirinho.png", use_column_width='auto', caption='Demandas da regional Pinheirinho')
     col2.image('https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_total.png', use_column_width='auto')
     st.write("Você selecionou a regional Pinheirinho. Esta regional é composta dos Bairros: **Capão Raso**, **Fanny**, **Lindóia**, **Novo Mundo** e	**Pinheirinho**.")
    elif regional == 'Regional portao':
     col1, col2 = st.beta_columns(2) 
     col1.image("https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_port%C3%A2o.png", use_column_width='auto', caption='Demandas da regional Portão')
     col2.image('https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_total.png', use_column_width='auto')
     st.write("Você selecionou a regional Portão. Esta regional é composta dos Bairros: **Água Verde**,	**Campo Comprido (Sul)**,	**Fazendinha**, **Guaíra**,	**Parolin**,	**Portão**,	**Santa Quitéria**,	**Seminário**	e **Vila Izabel**.")
    elif regional == 'Regional santa felicidade':
     col1, col2 = st.beta_columns(2) 
     col1.image("https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_santa-felicidade.png", use_column_width='auto', caption='Demandas da regional Santa Felicidade')
     col2.image('https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_total.png', use_column_width='auto')
     st.write("Você selecionou a regional Santa Felicidade. Esta regional é composta dos Bairros: **Butiatuvinha**, **Campina do Siqueira**,	**Cascatinha**,	**Campo Comprido (Norte)**,	**Lamenha Pequena**,	**Mossunguê**,	**Orleans**,	**Santa Felicidade**,	**Santo Inácio**,	**São Braz**,	**São João**,	**Vista Alegre**.")
    elif regional == 'Regional tatuquara':
     col1, col2 = st.beta_columns(2) 
     col1.image("https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_tatuquara.png", use_column_width='auto', caption='Demandas da regional Tatuquara')
     col2.image('https://raw.githubusercontent.com/fmarcelneves/Rental-price-analysis-and-forecast-Curitiba-PR/main/Images_regionais/demandas-curitiba_total.png', use_column_width='auto')
     st.write("Você selecionou a regional Tatuquara. Esta regional é composta dos Bairros: **Campo de Santana**, **Caximba**, **Tatuquara**.") 
    
    st.header('Passo 3. Escolha o IDHM')
    st.write('O valor do IDHM* (Índice de Desenvolvimento Humano Municipal) foi selecionado automaticamente conforme a regional escolhida (média entre os bairros)')
    if regional == 'Regional bairro novo':
     IDHM = st.slider("", min_value= rental["IDHM"].min(), value=0.70, max_value = rental["IDHM"].max())
    if regional == 'Regional boa vista':
     IDHM = st.slider("", min_value= rental["IDHM"].min(), value=0.89, max_value = rental["IDHM"].max())
    if regional == 'Regional boqueirao':
     IDHM = st.slider("", min_value= rental["IDHM"].min(), value=0.79, max_value = rental["IDHM"].max())
    if regional == 'Regional cajuru':
     IDHM = st.slider("", min_value= rental["IDHM"].min(), value=0.79, max_value = rental["IDHM"].max())
    if regional == 'Regional cic':
     IDHM = st.slider("", min_value= rental["IDHM"].min(), value=0.77, max_value = rental["IDHM"].max())
    if regional == 'Regional matriz':
     IDHM = st.slider("", min_value= rental["IDHM"].min(), value=0.92, max_value = rental["IDHM"].max())
    if regional == 'Regional pinheirinho':
     IDHM = st.slider("", min_value= rental["IDHM"].min(), value=0.81, max_value = rental["IDHM"].max())
    if regional == 'Regional portao':
     IDHM = st.slider("", min_value= rental["IDHM"].min(), value=0.89, max_value = rental["IDHM"].max())
    if regional == 'Regional santa felicidade':
     IDHM = st.slider("", min_value= rental["IDHM"].min(), value=0.86, max_value = rental["IDHM"].max())
    if regional == 'Regional tatuquara':
     IDHM = st.slider("", min_value= rental["IDHM"].min(), value=0.73, max_value = rental["IDHM"].max())

    st.sidebar.write("*O IDHM (Índice de Desenvolvimento Humano Municipal) brasileiro segue as mesmas três dimensões do IDH Global - longevidade, educação e renda, mas vai além: adequa a metodologia global ao contexto brasileiro e à disponibilidade de indicadores nacionais. O índice varia de 0 a 1. Quanto mais próximo de 1, maior o desenvolvimento humano. Aqui, o nível de granularidade varia conforme o bairro, estes valores foram extraídos do Atlas de Desenvolviemnto Humano do Brasil")
    st.write("Porém, você pode selecionar o valor de IDHM que quiser, e correspondente a algum bairro específico da Regional. O mapa abaixo possui os valores de IDHM de cada um dos bairros de Curitiba - PR.")
    with st.beta_expander("Veja o mapa"):
     st.plotly_chart(fig, use_container_width=True)

    st.header('Passo 4. Previsão')
    st.write("Pressione o botão para o app prever o valor de aluguel conforme suas preferências")
    pred = st.button('Previsão')
    if pred:
        features = preparing(quartos=quartos, areas=areas, IDHM=IDHM, regional=regional)
        prediction = round(model.predict(features)[0],2)
        output = st.success(f'Aluguel : R$ {prediction}')
    
if __name__ == '__main__':
    main()
